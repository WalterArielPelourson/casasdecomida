{% extends "base.html" %}

{% block title %}Gestión de Pedidos{% endblock %}

{% block content %}
    <h1 class="mb-4">Gestión de Pedidos</h1>

    <div class="card shadow-sm">
        <div class="card-header">
            <h5>Pedidos Recientes</h5>
        </div>
        <div class="card-body">
            {% if pedidos %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Dirección</th>
                            <th>Tipo Pedido</th> 
                            <th>Horario</th>
                            <th>Pago</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Repartidor</th> {# <-- Aquí es donde se mostrará el selector o el nombre #}
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in pedidos %}
                        <tr>
                            <td>{{ pedido.id_pedido }}</td>
                            <td>{{ pedido.cliente_nombre }} {{ pedido.cliente_apellido }}</td>
                            <td>{{ pedido.direccion_entrega }}</td>
                            <td>
                                {% if pedido.es_envio %}
                                    <span class="badge bg-primary">Envío</span>
                                {% else %}
                                    <span class="badge bg-secondary">Retiro</span>
                                {% endif %}
                            </td>
                            <td>{{ pedido.horario_entrega_dt.strftime('%d/%m %H:%M') }}</td>
                            <td>{{ pedido.forma_pago }}</td>
                            <td>${{ "{:,.2f}".format(pedido.costo_total) }}</td>
                            <td>
                                {% if pedido.estado_pago == 'Pagado' %}
                                    <span class="badge bg-success">{{ pedido.estado_pago }}</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">{{ pedido.estado_pago }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if pedido.es_envio %}
                                    {% if pedido.repartidor_nombre %}
                                        {# Si ya tiene repartidor asignado, solo lo mostramos #}
                                        {{ pedido.repartidor_nombre }} {{ pedido.repartidor_apellido }}
                                    {% else %}
                                        {# Si es envío y NO tiene repartidor, mostramos el selector para asignarlo #}
                                        <form action="{{ url_for('asignar_repartidor', id_pedido=pedido.id_pedido) }}" method="POST" class="d-flex">
                                            <select name="id_repartidor" class="form-select form-select-sm me-1" required>
                                                <option value="">Asignar...</option>
                                                {% for rep in repartidores %}
                                                    {# La consulta en app.py ya filtra por activo=1, así que esta condición es redundante pero no dañina #}
                                                    <option value="{{ rep.id_repartidor }}">{{ rep.nombre }} {{ rep.apellido }}</option>
                                                {% else %}
                                                    {# Este bloque se ejecuta si 'repartidores' está vacía #}
                                                    <option value="" disabled>No hay repartidores activos.</option>
                                                {% endfor %}
                                            </select>
                                            <button type="submit" class="btn btn-sm btn-primary">Asignar</button>
                                        </form>
                                    {% endif %}
                                {% else %}
                                    N/A {# Si no es envío, no aplica repartidor #}
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('detalle_pedido', id_pedido=pedido.id_pedido) }}" class="btn btn-sm btn-info me-2">Ver Detalle</a>
                                {% if pedido.estado_pago != 'Pagado' %}
                                    <form action="{{ url_for('marcar_pedido_pagado', id_pedido=pedido.id_pedido) }}" method="POST" style="display:inline;" onsubmit="return confirm('¿Marcar pedido #{{ pedido.id_pedido }} como pagado?');">
                                        <button type="submit" class="btn btn-sm btn-success">Marcar Pagado</button>
                                    </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <p class="text-center text-muted">No hay pedidos registrados.</p>
            {% endif %}
        </div>
    </div>
{% endblock %}